<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bahn-Copilot – Demo</title>
  <!--
  GitHub Pages Deployment (Single-File):
  1) Dieses File als "index.html" in ein neues GitHub-Repo legen (Branch: main).
  2) Settings → Pages → Branch: main / root → Save.
  3) Nach ~1 Min ist die Seite erreichbar unter
     https://<dein-user>.github.io/<repo-name>/

  Vercel Deployment (Alternative):
  - Repo importieren → Framework: "Other" (Static) → Build Command: none → Output: root
  - Fertig. URL: https://<projekt>.vercel.app/
  -->

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React UMD + Babel (für einfache Single-File-Demo) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gradient-to-b from-slate-50 to-white text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    // --- Utils ---------------------------------------------------------------
    function pad(n) { return String(n).padStart(2, "0"); }
    function addMinutes(date, minutes) { return new Date(date.getTime() + minutes * 60000); }

    // --- Smoke-Tests ---------------------------------------------------------
    (function runSmokeTests() {
      console.assert(pad(5) === "05", "pad() sollte 5 -> '05' liefern");
      console.assert(pad(12) === "12", "pad() sollte 12 -> '12' liefern");
      const base = new Date(1704103200000); // 2024-01-01T10:00:00.000Z
      const plus60 = addMinutes(base, 60);
      console.assert(plus60.getTime() - base.getTime() === 3600000, "addMinutes() sollte 60 Minuten addieren");
    })();

    // --- React-Komponente ----------------------------------------------------
    const { useMemo, useState } = React;

    function BahnCopilotDemo() {
      const [from, setFrom] = useState("");
      const [to, setTo] = useState("");
      const [outDate, setOutDate] = useState(""); // YYYY-MM-DD
      const [outTime, setOutTime] = useState(""); // HH:MM

      const [retEnabled, setRetEnabled] = useState(false);
      const [retDate, setRetDate] = useState("");
      const [retTime, setRetTime] = useState("");
      const [retAltDest, setRetAltDest] = useState("");

      const [maxTransfers, setMaxTransfers] = useState("1");
      const [minChange, setMinChange] = useState("10");
      const [preferICE, setPreferICE] = useState(true);
      const [allowIC, setAllowIC] = useState(true);
      const [allowRE, setAllowRE] = useState(false);
      const [showAltStations, setShowAltStations] = useState(true);

      const [generated, setGenerated] = useState("");
      const [copied, setCopied] = useState(false);

      const dateLong = useMemo(() => {
        if (!outDate) return "(Datum fehlt)";
        const d = new Date(outDate + (outTime ? `T${outTime}:00` : "T00:00:00"));
        try {
          return d.toLocaleDateString("de-DE", { weekday: "short", day: "2-digit", month: "2-digit", year: "numeric" });
        } catch {
          return outDate;
        }
      }, [outDate, outTime]);

      function generateMockConnections(direction = "outbound") {
        if (!from || !to || !outDate || !outTime) return [];
        const baseStart = new Date(`${outDate}T${outTime}:00`);

        const transfer = parseInt(maxTransfers, 10);
        const minChg = parseInt(minChange, 10);

        const legs = [];
        for (let i = 0; i < 3; i += 1) {
          const start = addMinutes(baseStart, i * 30);
          const firstLegDur = 60 + (preferICE ? 0 : 10) + i * 5; // ICE etwas schneller
          const changeTime = Math.max(minChg, 8 + i * 2);
          const secondLegDur = 80 + (allowRE ? 10 : 0) + (transfer === 0 ? 0 : i * 4);

          const midStation = preferICE ? "Mannheim Hbf" : (allowIC ? "Frankfurt(Main) Hbf" : "Kassel-Wilhelmshöhe");
          const startStr = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
          const arrFirst = addMinutes(start, firstLegDur);
          const depSecond = addMinutes(arrFirst, changeTime);
          const finalArr = addMinutes(depSecond, secondLegDur);

          const durationMin = Math.round((finalArr.getTime() - start.getTime()) / 60000);
          const h = Math.floor(durationMin / 60);
          const m = durationMin % 60;

          const train1 = preferICE ? "ICE" : (allowIC ? "IC" : "RE");
          const train2 = allowIC ? "ICE" : (allowRE ? "RE" : "IC");

          const gl1 = 4 + (i % 3);
          const gl2 = 5 + ((i + 1) % 3);

          legs.push({
            idx: i + 1,
            start: startStr,
            end: `${pad(finalArr.getHours())}:${pad(finalArr.getMinutes())}`,
            duration: `${h}:${pad(m)}`,
            transfers: 1,
            segments: [
              { from: direction === "outbound" ? from : (retAltDest || to), to: midStation, line: `${train1} ${500 + i * 2}`, platform: `Gl. ${gl1}` },
              { from: midStation, to: direction === "outbound" ? to : from, line: `${train2} ${600 + i * 3}`, platform: `Gl. ${gl2}` },
            ],
            change: changeTime,
            prognosis: i === 1 ? "+3 min Umstieg" : "pünktlich",
          });
        }
        return legs;
      }

      function timePlus(startStr, firstSegLine, minChangeMinutes) {
        const [h, m] = startStr.split(":").map(Number);
        const start = new Date();
        start.setHours(h, m, 0, 0);
        const firstDur = firstSegLine.includes("ICE") ? 60 : 70; // Demo-Annahme
        const dep2 = addMinutes(start, firstDur + minChangeMinutes);
        return `${pad(dep2.getHours())}:${pad(dep2.getMinutes())}`;
      }

      function buildEmailBlock() {
        const outLegs = generateMockConnections("outbound");
        if (outLegs.length === 0) {
          setGenerated("Bitte fülle mindestens Abfahrtsbahnhof, Zielbahnhof, Datum & Uhrzeit (Hinreise) aus.");
          return;
        }

        const title = `Verbindungen ${from} → ${to} (${dateLong})`;
        const lines = [title, ""]; // leere Zeile

        outLegs.forEach((l) => {
          lines.push(`${l.idx}) ${l.start}–${l.end} (${l.duration}) | ${l.transfers} Umstieg`);
          lines.push(`   ${l.segments[0].from} ${l.start} (${l.segments[0].line}) → ${l.segments[0].to}  ${l.segments[0].platform}`);
          lines.push(`   [Umstieg ${l.change} min]`);
          lines.push(`   ${l.segments[1].from} ${timePlus(l.start, l.segments[0].line, l.change)} (${l.segments[1].line}) → ${l.segments[1].to}  ${l.segments[1].platform}`);
          lines.push(`   Prognose: ${l.prognosis}`);
          lines.push("");
        });

        if (retEnabled && retDate && retTime) {
          const rTitle = `Rückfahrt (${retAltDest ? `ab ${retAltDest}` : `ab ${to}`}, ${new Date(`${retDate}T${retTime}:00`).toLocaleDateString("de-DE", { weekday: "short", day: "2-digit", month: "2-digit", year: "numeric" })})`;
          lines.push(rTitle);
          const retLegs = generateMockConnections("return");
          retLegs.forEach((l) => {
            lines.push(`- ${l.start}–${l.end} (${l.duration}), 1 Umstieg ${l.segments[0].to}, Übergang ${l.change} min`);
          });
        }

        lines.push("Hinweis: Demo mit Beispieldaten. Zeiten/Gleise sind Platzhalter.");

        setGenerated(lines.join("\n"));
        setCopied(false);
      }

      async function copyToClipboard() {
        if (!generated) return;
        try {
          await navigator.clipboard.writeText(generated);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } catch (e) {
          console.error(e);
          alert("Kopieren nicht erlaubt – bitte Text manuell markieren und kopieren.");
        }
      }

      return (
        <div className="min-h-screen w-full p-6">
          <div className="max-w-5xl mx-auto space-y-6">
            <header className="flex items-center justify-between">
              <h1 className="text-2xl md:text-3xl font-semibold">🚆 Bahn-Copilot – Demo (GitHub Pages ready)</h1>
            </header>

            <div className="grid md:grid-cols-3 gap-4">
              <div className="md:col-span-2 bg-white rounded-2xl shadow p-4 space-y-4">
                <h2 className="text-lg font-medium">Basisdaten</h2>
                <div className="grid sm:grid-cols-2 gap-3">
                  <label className="flex flex-col gap-1">
                    <span className="text-sm">Abfahrtsbahnhof</span>
                    <input className="border rounded-xl p-2" placeholder="z. B. Hamburg Hbf" value={from} onChange={(e)=>setFrom(e.target.value)} />
                  </label>
                  <label className="flex flex-col gap-1">
                    <span className="text-sm">Zielbahnhof</span>
                    <input className="border rounded-xl p-2" placeholder="z. B. Frankfurt(Main) Hbf" value={to} onChange={(e)=>setTo(e.target.value)} />
                  </label>
                  <label className="flex flex-col gap-1">
                    <span className="text-sm">Datum (Hin)</span>
                    <input type="date" className="border rounded-xl p-2" value={outDate} onChange={(e)=>setOutDate(e.target.value)} />
                  </label>
                  <label className="flex flex-col gap-1">
                    <span className="text-sm">Uhrzeit (Hin)</span>
                    <input type="time" className="border rounded-xl p-2" value={outTime} onChange={(e)=>setOutTime(e.target.value)} />
                  </label>
                </div>

                <div className="flex items-center justify-between mt-2">
                  <h2 className="text-lg font-medium">Rückfahrt (optional)</h2>
                  <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={retEnabled} onChange={(e)=>setRetEnabled(e.target.checked)} /> aktivieren</label>
                </div>
                {retEnabled && (
                  <div className="grid sm:grid-cols-3 gap-3">
                    <label className="flex flex-col gap-1">
                      <span className="text-sm">Datum (Rück)</span>
                      <input type="date" className="border rounded-xl p-2" value={retDate} onChange={(e)=>setRetDate(e.target.value)} />
                    </label>
                    <label className="flex flex-col gap-1">
                      <span className="text-sm">Uhrzeit (Rück)</span>
                      <input type="time" className="border rounded-xl p-2" value={retTime} onChange={(e)=>setRetTime(e.target.value)} />
                    </label>
                    <label className="flex flex-col gap-1 sm:col-span-1">
                      <span className="text-sm">abweichender Rück-Zielbahnhof</span>
                      <input className="border rounded-xl p-2" placeholder="optional, z. B. Köln Messe/Deutz" value={retAltDest} onChange={(e)=>setRetAltDest(e.target.value)} />
                    </label>
                  </div>
                )}

                <h2 className="text-lg font-medium mt-2">Optionen</h2>
                <div className="grid sm:grid-cols-3 gap-3">
                  <label className="flex flex-col gap-1">
                    <span className="text-sm">Max. Umstiege</span>
                    <select className="border rounded-xl p-2" value={maxTransfers} onChange={(e)=>setMaxTransfers(e.target.value)}>
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="99">egal</option>
                    </select>
                  </label>
                  <label className="flex flex-col gap-1">
                    <span className="text-sm">Mindest-Umsteigezeit (Min.)</span>
                    <select className="border rounded-xl p-2" value={minChange} onChange={(e)=>setMinChange(e.target.value)}>
                      <option value="5">5</option>
                      <option value="10">10</option>
                      <option value="15">15</option>
                    </select>
                  </label>
                  <div className="flex flex-col gap-2">
                    <span className="text-sm">Zugarten</span>
                    <div className="flex flex-wrap gap-3">
                      <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={preferICE} onChange={(e)=>setPreferICE(e.target.checked)} /> ICE bevorzugen</label>
                      <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={allowIC} onChange={(e)=>setAllowIC(e.target.checked)} /> IC erlauben</label>
                      <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={allowRE} onChange={(e)=>setAllowRE(e.target.checked)} /> RE erlauben</label>
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-3 mt-4">
                  <button onClick={buildEmailBlock} className="px-4 py-2 rounded-2xl bg-slate-900 text-white shadow hover:shadow-md active:scale-[0.99]">Verbindungen generieren</button>
                  <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={showAltStations} onChange={(e)=>setShowAltStations(e.target.checked)} /> Alternative Bahnhöfe anzeigen</label>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow p-4 space-y-3">
                <h2 className="text-lg font-medium">Ausgabe (Mail-Block)</h2>
                <textarea className="w-full h-96 border rounded-xl p-3 font-mono text-sm" value={generated} onChange={(e)=>setGenerated(e.target.value)} placeholder="Klicke auf ‘Verbindungen generieren’." />
                <div className="flex items-center gap-3">
                  <button onClick={copyToClipboard} className="px-3 py-2 rounded-2xl bg-slate-100 border hover:bg-slate-50">{copied ? "✔️ Kopiert" : "In Zwischenablage kopieren"}</button>
                  {showAltStations && (
                    <span className="text-xs text-slate-500">Tipp: Alternativbahnhöfe wie „Frankfurt Flughafen“ oder „Köln Messe/Deutz“ kannst du im Feld „abweichender Rück-Zielbahnhof“ testen.</span>
                  )}
                </div>
              </div>
            </div>

            <footer className="text-xs text-slate-500">
              Demo-Status: Mock-Daten ohne Gewähr. Nächster Schritt: echte Daten via DB-API (RIS) oder transport.rest anschließen.
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BahnCopilotDemo />);
  </script>
</body>
</html>
